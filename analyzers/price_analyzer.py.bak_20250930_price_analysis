import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
import logging


class PriceAnalyzer:
    def __init__(self, products_df):
        """PriceAnalyzer ì´ˆê¸°í™”

        Args:
            products_df (pd.DataFrame): CoupangParserë¥¼ í†µí•´ íŒŒì‹±ëœ ìƒí’ˆ ë°ì´í„°í”„ë ˆì„
        """
        self.products_df = products_df.copy()
        # 'price' ì»¬ëŸ¼ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš°, 0ìœ¼ë¡œ ì±„ì›Œì§„ ì»¬ëŸ¼ ìƒì„±
        if (
            "price" not in self.products_df.columns
            or self.products_df["price"].isnull().all()
        ):
            self.products_df["price"] = 0
        else:
            # NaN ê°’ì„ 0ìœ¼ë¡œ ì±„ìš°ê³  ì •ìˆ˜í˜•ìœ¼ë¡œ ë³€í™˜
            self.products_df["price"] = self.products_df["price"].fillna(0).astype(int)

        # --- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ ---
        logging.info(
            f"PriceAnalyzer ì´ˆê¸°í™” ì™„ë£Œ. ê°€ê²© ì»¬ëŸ¼ ìš”ì•½:\n{self.products_df['price'].describe().to_string()}"
        )
        # --------------------

    def analyze_prices(self):
        """ê°€ê²© ë°ì´í„° ì¢…í•© ë¶„ì„"""
        # ê°€ê²©ì´ 0ë³´ë‹¤ í° ìœ íš¨í•œ ë°ì´í„°ë§Œ í•„í„°ë§
        prices = self.products_df["price"][self.products_df["price"] > 0].dropna()

        # ë¶„ì„í•  ê°€ê²© ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° None ë°˜í™˜
        if prices.empty:
            return {
                "basic_stats": self._calculate_basic_stats(prices),
                "price_distribution": self._analyze_price_distribution(prices),
            }

        analysis = {
            "basic_stats": self._calculate_basic_stats(prices),
            "price_distribution": self._analyze_price_distribution(prices),
            # 'rocket_vs_normal': self._compare_rocket_prices(), # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„
            # 'seller_analysis': self._analyze_by_seller(), # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„
            # 'discount_analysis': self._analyze_discounts() # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„
        }

        return analysis

    def _calculate_basic_stats(self, prices):
        """ê¸°ë³¸ í†µê³„ ê³„ì‚°"""
        if prices.empty:
            return {
                "count": 0,
                "mean": 0,
                "median": 0,
                "std": 0,
                "min": 0,
                "max": 0,
                "q25": 0,
                "q75": 0,
            }

        return {
            "count": len(prices),
            "mean": prices.mean(),
            "median": prices.median(),
            "std": prices.std(),
            "min": prices.min(),
            "max": prices.max(),
            "q25": prices.quantile(0.25),
            "q75": prices.quantile(0.75),
        }

    def _analyze_price_distribution(self, prices):
        """ê°€ê²© ë¶„í¬ ë¶„ì„"""
        if prices.empty:
            return pd.Series(dtype=int)

        # ê°€ê²© êµ¬ê°„ ì„¤ì •
        bins = [0, 10000, 30000, 50000, 100000, 200000, float("inf")]
        labels = [
            "1ë§Œì› ë¯¸ë§Œ",
            "1-3ë§Œì›",
            "3-5ë§Œì›",
            "5-10ë§Œì›",
            "10-20ë§Œì›",
            "20ë§Œì› ì´ìƒ",
        ]

        price_ranges = pd.cut(
            prices, bins=bins, labels=labels, right=False, include_lowest=True
        )
        distribution = price_ranges.value_counts().sort_index()

        return distribution

    def create_price_chart(self):
        """ê°€ê²© ë¶„í¬ ì‹œê°í™” ì°¨íŠ¸ ìƒì„±"""
        analysis = self.analyze_prices()
        distribution = analysis["price_distribution"]

        if distribution.empty:
            fig = go.Figure().update_layout(
                title="ğŸ’° ê°€ê²© êµ¬ê°„ë³„ ìƒí’ˆ ë¶„í¬ (ë°ì´í„° ì—†ìŒ)",
                xaxis_title="ê°€ê²© êµ¬ê°„",
                yaxis_title="ìƒí’ˆ ìˆ˜",
                height=400,
                annotations=[
                    {
                        "text": "ë¶„ì„í•  ê°€ê²© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
                        "xref": "paper",
                        "yref": "paper",
                        "showarrow": False,
                        "font": {"size": 16},
                    }
                ],
            )
            return fig

        fig = px.bar(
            x=distribution.index,
            y=distribution.values,
            title="ğŸ’° ê°€ê²© êµ¬ê°„ë³„ ìƒí’ˆ ë¶„í¬",
            labels={"x": "ê°€ê²© êµ¬ê°„", "y": "ìƒí’ˆ ìˆ˜"},
            color=distribution.values,
            color_continuous_scale="Blues",
            text=distribution.values,
        )

        fig.update_layout(
            showlegend=False,
            height=400,
            xaxis_tickangle=-45,
            yaxis_title="ìƒí’ˆ ìˆ˜",
            xaxis_title="ê°€ê²© êµ¬ê°„",
        )
        fig.update_traces(textposition="outside")

        return fig

    def create_price_boxplot(self):
        """ê°€ê²© ë¶„í¬ Box Plot ìƒì„±"""
        prices = self.products_df["price"][self.products_df["price"] > 0].dropna()

        if prices.empty:
            return go.Figure().update_layout(
                title="ê°€ê²© ë¶„í¬ Box Plot (ë°ì´í„° ì—†ìŒ)",
                height=200,
                annotations=[
                    {
                        "text": "ë°ì´í„° ì—†ìŒ",
                        "xref": "paper",
                        "yref": "paper",
                        "showarrow": False,
                    }
                ],
            )

        fig = px.box(
            self.products_df[self.products_df["price"] > 0],
            x="price",
            title="ê°€ê²© ë¶„í¬ Box Plot",
            points="all",  # ëª¨ë“  ë°ì´í„° í¬ì¸íŠ¸ í‘œì‹œ
            hover_data=["name"],  # ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ìƒí’ˆëª… í‘œì‹œ
        )
        fig.update_layout(height=200, yaxis_title="")
        return fig
